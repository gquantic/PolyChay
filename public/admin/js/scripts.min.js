



document.querySelectorAll(".table__seach-btn").forEach(e => {
    e.addEventListener("click", () => {
        e.parentElement.querySelector(".table__seach-field").classList.toggle("active")
    })
});



document.querySelectorAll(".table__seach-field").forEach(l => {
    let c = l.querySelector('input[type="text"]');
    if (c) {
        let e = l.querySelectorAll(".table__seach-param-item"),
            a = [];
        e.forEach(e => {
            a.push([e.querySelector(".table__seach-name").innerHTML, e]), e.classList.add("show")
        });
        let t;
        c.addEventListener("input", () => {
            clearTimeout(t), t = setTimeout(() => {
                var t = c.value.trim().toLowerCase();
                a.forEach(e => {
                    e[0].toLowerCase().includes(t) ? e[1].classList.add("show") : e[1].classList.remove("show")
                })
            }, 300)
        })
    }
});





( function( $ ) {


    //убирает модалку когда кликаем вне модалки
    $(document).on('mouseup', function(e){
        if (!$('.table__seach-field').is(e.target) && $('.table__seach-field').has(e.target).length === 0) {
            $('.table__seach-field').removeClass('active');
        }
    });


    //при выборе "выбрать все" выбираются все опции
    $('input.all').on('click', function(){
        if ($(this).is(':checked')) {
            $('.table__seach-field.active input').prop('checked', true);
        } else {
            $('.table__seach-field.active input').prop('checked', false);
        }
    });


    $('input').on('change', function(){

        let name = [];
        let paid_period_start1 = '';
        let paid_period_start2 = '';
        let commission = [];
        let withdrawal_conditions = [];
        let organization_type = [];
        let connection_date1 = '';
        let connection_date2 = '';
        let town = [];
        let source = [];

        let token = $('input[name="_token"]').val();


        if($(this).closest("div").is("#search2")){
            paid_period_start1 = $('input[name="paid_period_start1"]').val();
            paid_period_start2 = $('input[name="paid_period_start2"]').val();
        }

        if($(this).closest("div").is("#search6")){
            connection_date1 = $('input[name="connection_date1"]').val();
            connection_date2 = $('input[name="connection_date2"]').val();
        }


        $('input').each(function() {

            if($(this).is(':checked') && $(this).siblings('.table__seach-name').text() !== "Выделить все"){
                if($(this).closest("div").is("#search1")){
                    name.push($(this).siblings('.table__seach-name').text());
                }
                if($(this).closest("div").is("#search3")){
                    commission.push($(this).siblings('.table__seach-name').text());
                }
                if($(this).closest("div").is("#search4")){
                    withdrawal_conditions.push($(this).siblings('.table__seach-name').text());
                }
                if($(this).closest("div").is("#search5")){
                    organization_type.push($(this).siblings('.table__seach-name').text());
                }
                if($(this).closest("div").is("#search7")){
                    town.push($(this).siblings('.table__seach-name').text());
                }
                if($(this).closest("div").is("#search8")){
                    source.push($(this).siblings('.table__seach-name').text());
                }
            }

        });



        $.ajax({
            type: 'POST',
            url: '/ajax/FilterHandler.php',
            dataType: 'text',
            data: {
                name: name,
                paid_period_start1: paid_period_start1,
                paid_period_start2: paid_period_start2,
                commission: commission,
                withdrawal_conditions: withdrawal_conditions,
                organization_type: organization_type,
                connection_date1: connection_date1,
                connection_date2: connection_date2,
                town: town,
                source: source,
            },
            beforeSend: function(xhr) {
                xhr.setRequestHeader('Csrf-Token', token);
            },
            success: function(result) {
                $('tbody.organizations_field_list').html(result);
            },
            error: function(xhr, ajaxOptions, thrownError){
                  console.log(xhr.status);
            }
        });


    });


} )( jQuery );
